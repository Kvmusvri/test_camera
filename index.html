<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    const snapButton = document.getElementById('snap');
    const sendButton = document.getElementById('send');
    const thumbnailContainer = document.getElementById('thumbnail');
    const fullscreenView = document.getElementById('fullscreenView');
    const slider = document.getElementById('slider');
    const closeBtn = document.getElementById('closeBtn');

    const tg = window.Telegram.WebApp;

    let currentStream;
    let photos = [];

    tg.expand();

    // Инициализация камеры
    async function startCamera() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
        }
        currentStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' }
        });
        video.srcObject = currentStream;
    }

    // Снимок и обновление миниатюры
    snapButton.addEventListener('click', () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const photoUrl = canvas.toDataURL("image/jpeg", 0.8); // Исходное сжатие
        photos.unshift(photoUrl);
        updateThumbnail(photoUrl);
    });

    // Обновление миниатюры
    function updateThumbnail(url) {
        thumbnailContainer.innerHTML = '';
        const img = document.createElement('img');
        img.src = url;
        img.addEventListener('click', openFullscreenView);
        thumbnailContainer.appendChild(img);
    }

    // Открыть полный экран
    function openFullscreenView() {
        slider.innerHTML = '';
        photos.forEach(photo => {
            const img = document.createElement('img');
            img.src = photo;
            slider.appendChild(img);
        });
        fullscreenView.style.display = 'flex';
    }

    // Закрыть полный экран
    closeBtn.addEventListener('click', () => {
        fullscreenView.style.display = 'none';
    });

    // Функция сжатия изображения
    function compressImage(imageDataUrl, maxWidth = 800, maxHeight = 800, quality = 0.7) {
        return new Promise(resolve => {
            const img = new Image();
            img.src = imageDataUrl;

            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // Вычисляем новый размер с учётом пропорций
                let { width, height } = img;
                if (width > maxWidth || height > maxHeight) {
                    if (width / height > maxWidth / maxHeight) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    } else {
                        width = Math.round((width * maxHeight) / height);
                        height = maxHeight;
                    }
                }

                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);

                // Сжимаем изображение
                resolve(canvas.toDataURL('image/jpeg', quality));
            };
        });
    }

    // Сжатие всех изображений
    async function compressAllImages(photos, maxDataSize = 64000) {
        const compressedPhotos = [];
        for (const photo of photos) {
            let compressedPhoto = await compressImage(photo);
            compressedPhotos.push(compressedPhoto);

            // Проверка общего размера
            const jsonData = JSON.stringify(compressedPhotos);
            if (jsonData.length > maxDataSize) {
                alert('Слишком много данных. Некоторые изображения могут быть исключены.');
                break;
            }
        }
        return compressedPhotos;
    }

    // Отправка данных в Telegram
    sendButton.addEventListener('click', async () => {
        if (photos.length > 0) {
            try {
                const compressedPhotos = await compressAllImages(photos);
                const jsonData = JSON.stringify(compressedPhotos);

                if (jsonData.length > 64000) {
                    alert('Размер данных превышает лимит. Уменьшите количество фотографий.');
                } else {
                    tg.sendData(jsonData);
                    alert('Фото отправлены!');
                    setTimeout(() => tg.close(), 100);
                }
            } catch (error) {
                alert('Ошибка при сжатии: ' + error.message);
            }
        } else {
            alert('Нет фото для отправки.');
        }
    });

    startCamera();
</script>
