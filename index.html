<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Камера</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/telegram-web-app/1.1.0/telegram-web-app.css" rel="stylesheet">
    <style>
        body { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            margin: 0; 
            background-color: #000; 
            font-family: 'Arial', sans-serif;
        }
        video { 
            width: 100%; 
            max-width: 400px; 
            border: 1px solid black; 
        }
        canvas { display: none; }
        img { margin-top: 10px; max-width: 100%; border: 1px solid black; }
        button { 
            background: rgba(255, 255, 255, 0.7); 
            border-radius: 50%; 
            border: none; 
            width: 80px; 
            height: 80px; 
            cursor: pointer; 
            position: absolute; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%); /* Центрирование кнопки */
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }
        button:focus {
            outline: none; /* Убираем контур при фокусе */
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jimp/0.16.1/jimp.min.js"></script> <!-- Подключение библиотеки Jimp -->
</head>
<body>
    <div style="position: relative;">
        <video id="video" autoplay playsinline muted></video>
        <button id="snap"></button> <!-- Кнопка сфотографировать -->
    </div>
    <canvas id="canvas"></canvas>
    <img id="photo" alt="Сфотографированное изображение">

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const photo = document.getElementById('photo');
        const snapButton = document.getElementById('snap');

        let currentStream;

        async function startCamera() {
            try {
                // Запрашиваем доступ к камере с тыльной камерой
                currentStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                video.srcObject = currentStream;
            } catch (err) {
                console.error("Ошибка доступа к камере:", err);
                alert("Не удалось получить доступ к камере. Убедитесь, что камера подключена и разрешите доступ.");
            }
        }

        // Инициализация камеры
        startCamera();

        // Обработчик захвата изображения
        snapButton.addEventListener('click', async () => {
            const width = video.videoWidth;
            const height = video.videoHeight;

            if (width && height) {
                canvas.width = width;
                canvas.height = height;

                // Задержка для уменьшения тряски
                await new Promise(resolve => setTimeout(resolve, 300)); // Задержка 300 мс
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, width, height);

                // Получаем изображение в виде Data URL
                const imageData = canvas.toDataURL('image/png');

                // Обработка изображения с помощью Jimp
                const image = await Jimp.read(imageData);
                image
                    .contrast(0.5)  // Увеличение контрастности
                    .quality(100)   // Полное качество
                    .getBase64(Jimp.MIME_PNG, (err, src) => {
                        if (err) {
                            console.error("Ошибка обработки изображения:", err);
                            return;
                        }
                        photo.setAttribute('src', src); // Устанавливаем улучшенное изображение
                    });
            } else {
                console.error("Не удалось получить размеры видео.");
                alert("Не удается сделать снимок. Убедитесь, что камера работает.");
            }
        });
    </script>
</body>
</html>
